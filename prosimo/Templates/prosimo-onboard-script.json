{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "16853361233687066783"
    }
  },
  "parameters": {
    "name": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "identityId": {
      "type": "string"
    },
    "prosimoTeamName": {
      "type": "string"
    },
    "prosimoApiToken": {
      "type": "string"
    },
    "clientId": {
      "type": "string"
    },
    "clientSecret": {
      "type": "string"
    },
    "managementGroupName": {
      "type": "string"
    }
  },
  "variables": {
    "tenantId": "[tenant().tenantId]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "kind": "AzurePowerShell",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('identityId'))]": {}
        }
      },
      "properties": {
        "azPowerShellVersion": "7.3",
        "cleanupPreference": "Always",
        "retentionInterval": "P1D",
        "timeout": "PT1H",
        "arguments": "[format('-prosimoTeamName ''{0}'' -prosimoApiToken ''{1}'' -clientId ''{2}'' -managementGroupName ''{3}'' -tenantId ''{4}'' -clientSecret ''{5}'' ', parameters('prosimoTeamName'), parameters('prosimoApiToken'), parameters('clientId'), parameters('managementGroupName'), variables('tenantId'), parameters('clientSecret'))]",
        "scriptContent": "    param(\n      [string] [Parameter(Mandatory=$true)] $prosimoTeamName,\n      [string] [Parameter(Mandatory=$true)] $prosimoApiToken,\n      [string] [Parameter(Mandatory=$true)] $clientId,\n      [string] [Parameter(Mandatory=$true)] $clientSecret,\n      [string] [Parameter(Mandatory=$true)] $managementGroupName,\n      [string] [Parameter(Mandatory=$true)] $tenantId\n    )\n    \n      Install-Module -Name Az.ResourceGraph -Force\n      $subscriptionList = (Search-AzGraph -Query \"ResourceContainers | where type =~ 'microsoft.resources/subscriptions'\" -ManagementGroup $managementGroupName).id\n    \n        $headers = @{\n          'content-type' = 'application/json'\n          'Prosimo-ApiToken' = $prosimoApiToken\n        }\n    \n        $uri = \"https://$prosimoTeamName.admin.prosimo.io/api/cloud/creds\"\n    \n        $clientId = $clientId\n        $tenantId = $tenantId\n        $clientSecret = $clientSecret\n    \n        foreach ($subscription in $subscriptionList) {\n          $subscriptionId = $subscription.Split(\"/\")[2]\n          $subscriptionName = (Get-AzSubscription -SubscriptionId $subscriptionId).Name \n    \n          $body = @\"\n          {\n            \"cloudType\": \"AZURE\",\n            \"keyType\": \"AZUREKEY\",\n            \"name\": \"$subscriptionName\",\n            \"details\": {\n                \"clientID\": \"$clientId\",\n                \"clientSecret\": \"$clientSecret\",\n                \"subscriptionID\": \"$subscriptionId\",\n                \"tenantID\": \"$tenantId\"\n            }\n        }    \n\"@\n          Invoke-RestMethod -Method Post -Uri $uri -Headers $headers -Body $body\n        }\n    "
      }
    }
  ],
  "outputs": {
    "scriptId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Resources/deploymentScripts', parameters('name'))]"
    }
  }
}