{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "2819692127165929042"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "requiredTags": {
      "type": "array",
      "defaultValue": [
        {
          "tagName": "Application Owner",
          "inheritTag": true
        },
        {
          "tagName": "Application Name",
          "inheritTag": false
        },
        {
          "tagName": "Criticality",
          "inheritTag": true
        },
        {
          "tagName": "Contact Email",
          "inheritTag": true
        },
        {
          "tagName": "Data Classification",
          "inheritTag": false
        }
      ]
    }
  },
  "variables": {
    "inheritTag": "/providers/Microsoft.Authorization/policyDefinitions/cd3aa116-8754-49c9-a813-ad46512ece54",
    "requireTag": "/providers/Microsoft.Authorization/policyDefinitions/96670d01-0a4d-4649-9c89-2d3abc0a5025",
    "tagContributor": "4a9ae827-6dc8-4573-8ac7-8239d42aa03f"
  },
  "resources": [
    {
      "copy": {
        "name": "requiredTagPolicy",
        "count": "[length(range(0, length(parameters('requiredTags'))))]"
      },
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2021-06-01",
      "name": "[uniqueString(parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname, managementGroup().id, variables('requireTag'))]",
      "properties": {
        "policyDefinitionId": "[variables('requireTag')]",
        "description": "[format('Require {0} tag for Resource Groups', parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname)]",
        "displayName": "[format('Require {0} tag for Resource Groups', parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname)]",
        "enforcementMode": "Default",
        "nonComplianceMessages": [
          {
            "message": "[format('Supply the tag and value for: {0}', parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname)]"
          }
        ],
        "parameters": {
          "tagName": {
            "value": "[parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname]"
          }
        }
      }
    },
    {
      "condition": "[parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].inheritTag]",
      "copy": {
        "name": "inheritTagPolicy",
        "count": "[length(range(0, length(parameters('requiredTags'))))]"
      },
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}', take(format('Tag-{0}', replace(parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname, ' ', '')), 24))]",
      "location": "[parameters('location')]",
      "properties": {
        "policyDefinitionId": "[variables('inheritTag')]",
        "description": "[format('Inherit {0} tag for resources if missing.', parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname)]",
        "displayName": "[format('Inherit {0} tag for resources if missing.', parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname)]",
        "enforcementMode": "Default",
        "parameters": {
          "tagName": {
            "value": "[parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].tagname]"
          }
        }
      },
      "identity": {
        "type": "SystemAssigned"
      }
    },
    {
      "condition": "[parameters('requiredTags')[range(0, length(parameters('requiredTags')))[copyIndex()]].inheritTag]",
      "copy": {
        "name": "assignRole",
        "count": "[length(range(0, length(parameters('requiredTags'))))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-08-01-preview",
      "name": "[guid(extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyAssignments', format('{0}', take(format('Tag-{0}', replace(parameters('requiredTags')[range(0, length(parameters('requiredTags')))[range(0, length(parameters('requiredTags')))[copyIndex()]]].tagname, ' ', '')), 24))))]",
      "properties": {
        "principalId": "[reference(extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyAssignments', format('{0}', take(format('Tag-{0}', replace(parameters('requiredTags')[range(0, length(parameters('requiredTags')))[range(0, length(parameters('requiredTags')))[copyIndex()]]].tagname, ' ', '')), 24)))).policyDefinitionId]",
        "roleDefinitionId": "[variables('tagContributor')]"
      },
      "dependsOn": [
        "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyAssignments', format('{0}', take(format('Tag-{0}', replace(parameters('requiredTags')[range(0, length(parameters('requiredTags')))[range(0, length(parameters('requiredTags')))[copyIndex()]]].tagname, ' ', '')), 24)))]",
        "[extensionResourceId(managementGroup().id, 'Microsoft.Authorization/policyAssignments', format('{0}', take(format('Tag-{0}', replace(parameters('requiredTags')[range(0, length(parameters('requiredTags')))[range(0, length(parameters('requiredTags')))[copyIndex()]]].tagname, ' ', '')), 24)))]"
      ]
    }
  ]
}